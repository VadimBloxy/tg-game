<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHOST HUNTER: THE COMPLETE SAGA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --gold: #ffcc00; --blood: #af0000; --ghost: #8899cc;
            --bg: #0a0a0a; --panel: #1a1512; --text: #d2b48c; --xp: #4caf50;
        }
        body {
            background: var(--bg); color: var(--text); font-family: 'Courier New', monospace;
            margin: 0; padding: 15px; display: flex; justify-content: center;
            overflow: hidden; touch-action: manipulation; transition: background 0.2s;
        }
        #game-container {
            width: 100%; max-width: 420px; background: var(--panel);
            border: 3px solid #3e2723; border-radius: 12px; padding: 15px;
            box-sizing: border-box; box-shadow: 0 0 25px rgba(0,0,0,0.8);
            position: relative; transition: transform 0.1s;
        }
        .header { text-align: center; border-bottom: 2px solid #3e2723; margin-bottom: 10px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; margin: 4px 0; overflow: hidden; }
        #sanity-fill { width: 0%; height: 100%; background: var(--ghost); transition: 0.4s; }
        #xp-fill { width: 0%; height: 100%; background: var(--xp); transition: 0.4s; }
        #enemy-hp-fill { width: 100%; height: 100%; background: var(--blood); transition: 0.3s; }
        
        /* –í–∏–∑—É–∞–ª –≤—Ä–∞–≥–∞ */
        #enemy-sprite { font-size: 65px; text-align: center; margin: 15px 0; transition: all 0.2s; }
        .narrator-skin { animation: narrator-anim 0.5s infinite alternate; text-shadow: 0 0 20px var(--gold); }
        @keyframes narrator-anim {
            0% { transform: scale(1) rotate(-2deg); filter: hue-rotate(0deg); }
            100% { transform: scale(1.1) rotate(2deg); filter: hue-rotate(90deg); }
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
        .shake { animation: shake-anim 0.2s cubic-bezier(.36,.07,.19,.97); }
        @keyframes shake-anim {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            30%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .reality-glitch { animation: glitch-anim 0.1s infinite; filter: invert(1) contrast(2); }
        @keyframes glitch-anim { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        #event-log {
            height: 100px; overflow-y: auto; margin: 10px 0; padding: 8px;
            background: rgba(0,0,0,0.6); border-left: 3px solid var(--blood);
            font-size: 11px; line-height: 1.4; display: flex; flex-direction: column-reverse;
        }
        .inventory { display: flex; gap: 5px; margin: 10px 0; padding: 5px; background: #000; border-radius: 5px; min-height: 40px; }
        .inv-slot { width: 35px; height: 35px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
        
        .controls { display: grid; grid-template-columns: 1fr; gap: 6px; }
        button {
            background: #3e2723; color: var(--text); border: 1px solid #5d4037;
            padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold;
            text-transform: uppercase; font-family: 'Courier New', monospace; font-size: 11px;
        }
        button:active { transform: scale(0.98); background: var(--gold); color: black; }
        button:disabled { opacity: 0.3; }

        .ui-overlay { border: 2px solid var(--ghost); padding: 10px; margin-bottom: 10px; display: none; background: #0b0b0b; border-radius: 8px; }
        #enemy-zone { border-color: var(--blood); display: none; }
        
        #ending {
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: black; color: white; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; z-index: 1000; padding: 25px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ending">
        <h1 style="color:var(--gold)">THE STORY ENDS</h1>
        <p id="ending-msg" style="font-size:14px; line-height:1.6;"></p>
        <button onclick="localStorage.clear(); location.reload();" style="background:white; color:black">REWRITE HISTORY</button>
    </div>

    <div class="header"><h3>üíÄ DEAD WEST COMPLETE</h3></div>

    <div class="stats">
        <div>Gold: $<span id="v-gold">0</span></div>
        <div>Ammo: <span id="v-ammo">0</span></div>
        <div>Level: <span id="v-lvl">1</span></div>
        <div>SP: <span id="v-sp">0</span></div>
        <div id="comp-tag" style="grid-column: span 2; font-size:10px; color:var(--ghost);">No Companion</div>
        <div style="grid-column: span 2;">
            Sanity <div class="bar-bg"><div id="sanity-fill"></div></div>
            XP <div class="bar-bg"><div id="xp-fill"></div></div>
        </div>
        <div style="grid-column: span 2; display: flex; gap: 5px; margin-top:5px;">
            <button onclick="save()" style="flex:1; padding:2px; font-size:8px;">üíæ SAVE</button>
            <button onclick="load()" style="flex:1; padding:2px; font-size:8px;">üìÇ LOAD</button>
        </div>
    </div>

    <div id="inventory-ui" class="inventory"></div>

    <div id="enemy-zone" class="ui-overlay">
        <div id="enemy-sprite">üëª</div>
        <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold;">
            <span id="enemy-name">GHOST</span><span>HP</span>
        </div>
        <div class="bar-bg"><div id="enemy-hp-fill"></div></div>
        <div id="enemy-intent" style="text-align:center; font-size:9px; color:var(--gold);"></div>
    </div>

    <div id="skill-menu" class="ui-overlay">
        <div style="text-align:center; color:var(--xp); margin-bottom:8px;">SKILLS</div>
        <div class="controls">
            <button id="btn-ds" onclick="learn('doubleShot')">Double Shot (1 SP)</button>
            <button id="btn-iw" onclick="learn('ironWill')">Iron Will (1 SP)</button>
            <button onclick="closeUI()">Back</button>
        </div>
    </div>

    <div id="pet-menu" class="ui-overlay">
        <div style="text-align:center; margin-bottom:8px;">STABLES</div>
        <div class="controls">
            <button onclick="buyPet('dog')">üêï Ghost Dog ($150) - +Atk</button>
            <button onclick="buyPet('raven')">üê¶ Shadow Raven ($150) - +Loot</button>
            <button onclick="closeUI()">Back</button>
        </div>
    </div>

    <div id="event-log"></div>
    <div id="action-buttons" class="controls"></div>
</div>

<script>
    let state = {
        gold: 100, ammo: 15, sanity: 0, level: 1, xp: 0, xpNext: 100, sp: 0,
        baseAtk: 25, inventory: [], enemy: null, isNight: false,
        companion: null, hasCursedGun: false, gameEnded: false,
        skills: { doubleShot: false, ironWill: false }
    };

    function log(msg, color = "#aaa") {
        const el = document.getElementById('event-log');
        el.innerHTML = `<div style="color:${color}">> ${msg}</div>` + el.innerHTML;
    }

    function fxShake() {
        const gc = document.getElementById('game-container');
        gc.classList.add('shake');
        setTimeout(() => gc.classList.remove('shake'), 200);
    }

    function save() { localStorage.setItem('gh_final_saga', JSON.stringify(state)); log("Saved."); }
    function load() {
        const s = localStorage.getItem('gh_final_saga');
        if(s) { state = JSON.parse(s); updateDisplay(); log("Loaded."); }
    }

    function closeUI() {
        document.getElementById('skill-menu').style.display = 'none';
        document.getElementById('pet-menu').style.display = 'none';
        updateDisplay();
    }

    function buyPet(type) {
        if(state.gold >= 150) {
            state.gold -= 150; state.companion = type;
            log(`New companion: ${type}!`); closeUI();
        } else { log("No gold!"); }
    }

    function updateDisplay() {
        if(state.gameEnded) return;
        document.getElementById('v-gold').innerText = state.gold;
        document.getElementById('v-ammo').innerText = state.ammo;
        document.getElementById('v-lvl').innerText = state.level;
        document.getElementById('v-sp').innerText = state.sp;
        document.getElementById('sanity-fill').style.width = state.sanity + '%';
        document.getElementById('xp-fill').style.width = (state.xp / state.xpNext * 100) + '%';
        
        document.getElementById('comp-tag').innerText = state.companion ? `Active Pet: ${state.companion}` : "No Companion";

        const inv = document.getElementById('inventory-ui');
        inv.innerHTML = '';
        state.inventory.forEach((item, i) => {
            const s = document.createElement('div'); s.className = 'inv-slot';
            s.innerHTML = 'üß®'; s.onclick = () => useTNT(i);
            inv.appendChild(s);
        });

        const ez = document.getElementById('enemy-zone');
        const cont = document.getElementById('game-container');
        if(state.enemy) {
            ez.style.display = 'block';
            document.getElementById('enemy-name').innerText = state.enemy.name;
            document.getElementById('enemy-sprite').innerText = state.enemy.icon;
            document.getElementById('enemy-hp-fill').style.width = (state.enemy.hp / state.enemy.maxHp * 100) + '%';
            
            if(state.enemy.name === "NARRATOR") {
                document.getElementById('enemy-sprite').className = 'narrator-skin';
                if(state.enemy.hp < state.enemy.maxHp / 2) cont.classList.add('reality-glitch');
            } else {
                document.getElementById('enemy-sprite').className = '';
                cont.classList.remove('reality-glitch');
            }
        } else {
            ez.style.display = 'none';
            cont.classList.remove('reality-glitch');
        }

        renderButtons();
    }

    function renderButtons() {
        const btns = document.getElementById('action-buttons');
        let h = '';
        if(state.enemy) {
            h = `<button onclick="attack('shoot')" style="background:#700">üî• SHOOT</button>`;
            if(state.hasCursedGun) h += `<button onclick="attack('cursed')" style="background:#4a148c">üíÄ BLOOD SHOT</button>`;
            if(state.skills.doubleShot) h += `<button onclick="attack('double')" style="background:#a00">üî• DOUBLE</button>`;
            h += `<button onclick="attack('dodge')">üèÉ DODGE</button>`;
        } else if(!state.isNight) {
            h = `<button onclick="shop('ammo')">üõí AMMO ($25)</button>
                 <button onclick="shop('tnt')">üß® DYNAMITE ($50)</button>
                 <button onclick="document.getElementById('pet-menu').style.display='block'">üêï STABLES</button>
                 <button onclick="document.getElementById('skill-menu').style.display='block'">‚≠ê SKILLS</button>`;
            if(state.level >= 5 && !state.hasCursedGun) h += `<button onclick="shop('cursed')" style="color:var(--blood)">üíÄ CURSED GUN ($250)</button>`;
            h += `<button onclick="state.isNight=true; updateDisplay()" style="color:var(--ghost)">üåô START HUNT</button>`;
        } else {
            h = `<button onclick="scout()">üîç SCOUT</button>
                 <button onclick="state.isNight=false; updateDisplay()">üèÉ RETREAT</button>`;
        }
        btns.innerHTML = h;
    }

    function attack(t) {
        let d = 0;
        if(t === 'shoot' && state.ammo >= 1) { state.ammo--; d = state.baseAtk + Math.random()*15; }
        else if(t === 'double' && state.ammo >= 2) { state.ammo -= 2; d = state.baseAtk * 2.5; }
        else if(t === 'cursed') { state.sanity += 10; d = 200; log("The gun bites!", "red"); }
        else if(t === 'dodge' && Math.random() > 0.5) { log("Dodged!"); return updateDisplay(); }

        if(d > 0) {
            if(state.companion === 'dog') d += 15;
            state.enemy.hp -= d;
            if(state.enemy.hp <= 0) {
                if(state.enemy.name === "NARRATOR") return doEnd();
                log("Entity banished!"); state.gold += 60; state.xp += 40; state.enemy = null;
                if(state.xp >= state.xpNext) { state.level++; state.sp++; state.xp = 0; state.xpNext *= 1.4; }
                save();
            } else { enemyTurn(); }
        }
        updateDisplay();
    }

    function enemyTurn() {
        fxShake();
        let dmg = 12 + state.level;
        if(state.skills.ironWill) dmg *= 0.6;
        state.sanity += Math.floor(dmg);
        if(state.sanity >= 100) { alert("DEAD BY MADNESS"); location.reload(); }
    }

    function scout() {
        state.sanity += 5;
        if(Math.random() > 0.45) {
            const isN = Math.random() > 0.9 && state.level >= 8;
            state.enemy = isN ? 
                { name: "NARRATOR", icon: "üìñ‚ú®", hp: 1000, maxHp: 1000 } : 
                { name: "GHOST", icon: "üëª", hp: 100 + (state.level*20), maxHp: 100 + (state.level*20) };
            log(isN ? "THE AUTHOR IS HERE." : "Shadow emerges.");
        } else {
            let g = 25; if(state.companion === 'raven') g += 25;
            state.gold += g; log(`Found $${g}`);
        }
        updateDisplay();
    }

    function shop(t) {
        if(t === 'ammo' && state.gold >= 25) { state.gold -= 25; state.ammo += 15; }
        if(t === 'tnt' && state.gold >= 50) { state.gold -= 50; state.inventory.push('tnt'); }
        if(t === 'cursed' && state.gold >= 250) { state.gold -= 250; state.hasCursedGun = true; }
        updateDisplay();
    }

    function useTNT(i) {
        if(state.enemy) { state.enemy.hp -= 250; state.inventory.splice(i,1); log("BOOM!"); if(state.enemy.hp <= 0) { if(state.enemy.name === "NARRATOR") doEnd(); else state.enemy = null; } updateDisplay(); }
    }

    function learn(s) { if(state.sp >= 1) { state.sp--; state.skills[s] = true; updateDisplay(); } }

    function doEnd() {
        state.gameEnded = true;
        document.getElementById('ending').style.display = 'flex';
        document.getElementById('ending-msg').innerText = "The ink of fate has dried. By defeating the Narrator, you have freed the Dead West from its endless nightmare. Your story is now your own. Congratulations, Hunter.";
    }

    updateDisplay();
</script>
</body>
</html>
