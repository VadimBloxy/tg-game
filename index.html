<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST HUNTER: NARRATOR EDITION</title>
    <style>
        :root {
            --gold: #ffcc00; --blood: #af0000; --ghost: #8899cc;
            --bg: #0d0d0d; --panel: #1e1a17; --text: #d2b48c; --xp: #4caf50;
        }
        body {
            background: var(--bg); color: var(--text); font-family: 'Courier New', monospace;
            margin: 0; padding: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw; overflow: hidden;
        }
        #game-container {
            width: 1200px; height: 800px;
            background: var(--panel); border: 5px solid #3e2723; border-radius: 15px;
            padding: 30px; box-sizing: border-box; box-shadow: 0 0 50px rgba(0,0,0,0.9);
            position: relative; display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px;
        }
        
        .side-panel { display: flex; flex-direction: column; gap: 15px; }
        .main-panel { display: flex; flex-direction: column; justify-content: space-between; position: relative; }

        .header { text-align: center; border-bottom: 3px solid #3e2723; padding-bottom: 10px; grid-column: span 3; }
        .header h1 { margin: 0; font-size: 32px; letter-spacing: 5px; color: var(--gold); }

        .stats-box { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; border: 1px solid #3e2723; }
        .stats-box div { margin: 8px 0; font-size: 18px; }
        
        .bar-background { width: 100%; height: 15px; background: #222; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #444; }
        #sanity-fill { width: 0%; height: 100%; background: var(--ghost); transition: 0.5s; }
        #experience-fill { width: 0%; height: 100%; background: var(--xp); transition: 0.5s; }
        #enemy-health-fill { width: 100%; height: 100%; background: var(--blood); transition: 0.3s; }

        #enemy-zone { 
            flex-grow: 1; display: none; flex-direction: column; align-items: center; justify-content: center;
            border: 2px dashed var(--blood); border-radius: 20px; margin: 20px 0; background: rgba(0,0,0,0.2);
        }
        
        #enemy-sprite { font-size: 150px; margin: 20px 0; transition: 0.3s; display: flex; align-items: center; justify-content: center; }

        .narrator-image {
            width: 300px; height: 300px; object-fit: contain;
            animation: narrator-float 2s infinite alternate ease-in-out;
            filter: drop-shadow(0 0 30px var(--gold)); border-radius: 20px;
        }
        @keyframes narrator-float { 
            from { transform: translateY(0) rotate(-1deg); } 
            to { transform: translateY(-25px) rotate(1deg); } 
        }

        #event-log {
            height: 400px; overflow-y: auto; background: rgba(0,0,0,0.6);
            border-left: 5px solid var(--blood); padding: 15px; font-size: 14px;
            display: flex; flex-direction: column-reverse; line-height: 1.6; border-radius: 5px;
        }

        .inventory-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; padding: 10px; background: #000; border-radius: 10px; 
            min-height: 70px;
        }
        .inventory-slot { height: 60px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; }

        .controls-layout { display: grid; grid-template-columns: 1fr; gap: 10px; }
        button {
            background: #3e2723; color: var(--text); border: 2px solid #5d4037;
            padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold;
            text-transform: uppercase; font-size: 14px; transition: 0.2s;
        }
        button:hover { background: #5d4037; }
        button:active { background: var(--gold); color: black; }
        button:disabled { opacity: 0.3; cursor: default; }

        .overlay-window { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 500px; background: #121a22; border: 3px solid var(--ghost);
            padding: 30px; z-index: 100; display: none; border-radius: 15px;
        }

        #ending-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: black; z-index: 2000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="header"><h1>üíÄ GHOST HUNTER: DEAD WEST</h1></div>

    <div class="side-panel">
        <div class="stats-box">
            <h2 style="margin:0; color:var(--gold)">HUNTER</h2>
            <div>Gold: $<span id="display-gold">0</span></div>
            <div>Ammo: <span id="display-ammo">0</span></div>
            <div>Level: <span id="display-level">1</span></div>
            <div>SP: <span id="display-skill-points">0</span></div>
            <div id="display-weapon-name" style="color:var(--gold)">Colt .45</div>
            <div id="display-companion-name" style="color:var(--ghost); font-size:14px;">No Companion</div>
        </div>
        <div class="stats-box">
            Sanity (Mental HP)
            <div class="bar-background"><div id="sanity-fill"></div></div>
            Experience
            <div class="bar-background"><div id="experience-fill"></div></div>
        </div>
        <h3>SADDLEBAGS</h3>
        <div id="inventory-container" class="inventory-grid"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="saveGame()">SAVE</button>
            <button onclick="loadGame()">LOAD</button>
        </div>
    </div>

    <div class="main-panel">
        <div id="enemy-zone">
            <div id="enemy-sprite"></div>
            <h2 id="enemy-display-name" style="margin:0; font-size:32px;">GHOST</h2>
            <div class="bar-background" style="width:80%; height:25px;"><div id="enemy-health-fill"></div></div>
        </div>
        <div id="event-log"></div>
    </div>

    <div class="side-panel">
        <h3 style="text-align:center;">ACTIONS</h3>
        <div id="action-buttons-container" class="controls-layout"></div>
    </div>

    <div id="skill-menu" class="overlay-window">
        <h2 style="text-align:center; color:var(--xp)">SKILLS (SP: <span id="display-skill-points-menu">0</span>)</h2>
        <div class="controls-layout">
            <button id="skill-button-doubleShot" onclick="learnSkill('doubleShot')">Double Shot (1 SP)</button>
            <button id="skill-button-ironWill" onclick="learnSkill('ironWill')">Iron Will (1 SP)</button>
            <button id="skill-button-expandInventory" onclick="upgradeInventorySize()">Expand Bags (2 SP)</button>
            <button onclick="closeAllMenus()" style="margin-top:20px; background:#222">BACK</button>
        </div>
    </div>
</div>

<div id="ending-screen">
    <h1 style="font-size:60px; color:var(--gold)">THE STORY ENDS</h1>
    <p id="ending-message" style="max-width:800px; font-size:24px; color:#ccc;"></p>
    <button onclick="location.reload()" style="font-size:24px; padding:30px;">START OVER</button>
</div>

<script>
    const NARRATOR_IMAGE_PATH = "file:///Users/vadim/Downloads/Narrator.jpg";

    let gameState = {
        gold: 150,
        ammo: 30,
        sanity: 0,
        level: 1,
        experience: 0,
        experienceNeeded: 100,
        skillPoints: 0,
        baseAttackDamage: 35,
        inventory: [],
        activeEnemy: null,
        isNightTime: false,
        maxInventorySlots: 4,
        isGameFinished: false,
        skillsLearned: {
            doubleShot: false,
            ironWill: false
        },
        hasRailgun: false,
        isPlayerStunned: false
    };

    function addLogMessage(message, color = "#aaa") {
        const logContainer = document.getElementById('event-log');
        logContainer.innerHTML = `<div style="color:${color}">> ${message}</div>` + logContainer.innerHTML;
    }

    function saveGame() {
        const dataToSave = JSON.parse(JSON.stringify(gameState));
        dataToSave.activeEnemy = null;
        dataToSave.isNightTime = false;
        localStorage.setItem('GHOST_HUNTER_SAVE_DATA', JSON.stringify(dataToSave));
        addLogMessage("Progress recorded in the archives.", "var(--xp)");
    }

    function loadGame() {
        const savedData = localStorage.getItem('GHOST_HUNTER_SAVE_DATA');
        if (savedData) {
            gameState = JSON.parse(savedData);
            updateUserInterface();
            addLogMessage("Progress restored.", "var(--gold)");
        }
    }

    function updateUserInterface() {
        if (gameState.isGameFinished) return;

        document.getElementById('display-gold').innerText = gameState.gold;
        document.getElementById('display-ammo').innerText = gameState.ammo;
        document.getElementById('display-level').innerText = gameState.level;
        document.getElementById('display-skill-points').innerText = gameState.skillPoints;
        document.getElementById('display-skill-points-menu').innerText = gameState.skillPoints;
        document.getElementById('display-weapon-name').innerText = gameState.hasRailgun ? "‚ö° RAILGUN" : "COLT .45";
        
        document.getElementById('sanity-fill').style.width = gameState.sanity + '%';
        document.getElementById('experience-fill').style.width = (gameState.experience / gameState.experienceNeeded * 100) + '%';

        const inventoryUI = document.getElementById('inventory-container');
        inventoryUI.innerHTML = '';
        for (let i = 0; i < gameState.maxInventorySlots; i++) {
            const slotElement = document.createElement('div');
            slotElement.className = 'inventory-slot';
            if (gameState.inventory[i]) {
                slotElement.innerHTML = gameState.inventory[i] === 'tnt' ? 'üß®' : 'ü•É';
                slotElement.onclick = () => useInventoryItem(i);
            } else {
                slotElement.style.opacity = "0.2";
            }
            inventoryUI.appendChild(slotElement);
        }

        const enemyArea = document.getElementById('enemy-zone');
        if (gameState.activeEnemy) {
            enemyArea.style.display = 'flex';
            document.getElementById('enemy-display-name').innerText = gameState.activeEnemy.name;
            document.getElementById('enemy-health-fill').style.width = (gameState.activeEnemy.health / gameState.activeEnemy.maxHealth * 100) + '%';
            
            const spriteContainer = document.getElementById('enemy-sprite');
            if (gameState.activeEnemy.name === "NARRATOR") {
                spriteContainer.innerHTML = `<img src="${NARRATOR_IMAGE_PATH}" class="narrator-image">`;
            } else {
                spriteContainer.innerHTML = gameState.activeEnemy.icon;
            }
        } else {
            enemyArea.style.display = 'none';
        }
        
        refreshActionButtons();
    }

    function refreshActionButtons() {
        const buttonContainer = document.getElementById('action-buttons-container');
        let htmlContent = '';

        if (gameState.activeEnemy) {
            if (gameState.isPlayerStunned) {
                htmlContent += `<button disabled style="color:red">STUNNED BY THE INK</button>`;
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ —Ö–æ–¥–∞ –≤—Ä–∞–≥–∞, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –æ–≥–ª—É—à–µ–Ω
                setTimeout(() => { gameState.isPlayerStunned = false; enemyTurnLogic(); }, 1000);
            } else {
                htmlContent += `<button onclick="processAttack('shoot')">üî• SHOOT</button>`;
                if (gameState.hasRailgun) {
                    htmlContent += `<button onclick="processAttack('railgun')" style="background:#00bcd4; color:black">‚ö° RAILGUN</button>`;
                }
                if (gameState.skillsLearned.doubleShot) {
                    htmlContent += `<button onclick="processAttack('double')">üî• DOUBLE SHOT</button>`;
                }
                htmlContent += `<button onclick="enemyTurnLogic()">üèÉ DODGE</button>`;
            }
        } else if (!gameState.isNightTime) {
            htmlContent += `<button onclick="openShop('ammo')">üõí BUY AMMO ($25)</button>`;
            htmlContent += `<button onclick="openShop('tnt')">üß® BUY DYNAMITE ($50)</button>`;
            htmlContent += `<button onclick="openShop('whiskey')">ü•É BUY WHISKEY ($40)</button>`;
            htmlContent += `<button onclick="document.getElementById('skill-menu').style.display='block'">‚≠ê UPGRADES</button>`;
            if (gameState.level >= 8 && !gameState.hasRailgun) {
                htmlContent += `<button onclick="openShop('railgun')" style="color:#00bcd4;">‚ö° RAILGUN ($3000)</button>`;
            }
            htmlContent += `<button onclick="startHuntingNight()" style="background:#333">üåô START HUNT</button>`;
        } else {
            htmlContent += `<button onclick="scoutArea()" style="padding:30px;">üîç SCOUT AREA</button>`;
            htmlContent += `<button onclick="returnToSafeTown()">üèÉ RETURN TO TOWN</button>`;
        }
        buttonContainer.innerHTML = htmlContent;
    }

    function processAttack(method) {
        if (!gameState.activeEnemy) return;

        let finalDamage = gameState.baseAttackDamage + (Math.random() * 20);

        if (method === 'shoot') {
            if (gameState.ammo >= 1) {
                gameState.ammo -= 1;
            } else {
                addLogMessage("No ammo left!", "red");
                return;
            }
        } else if (method === 'double') {
            if (gameState.ammo >= 2) {
                gameState.ammo -= 2;
                finalDamage *= 2.5;
            } else {
                addLogMessage("Not enough ammo!", "red");
                return;
            }
        } else if (method === 'railgun') {
            if (gameState.ammo >= 100) {
                gameState.ammo -= 100;
                finalDamage = 500;
            } else {
                addLogMessage("Railgun needs 100 ammo to fire!", "red");
                return;
            }
        }

        gameState.activeEnemy.health -= finalDamage;
        addLogMessage(`You dealt ${Math.floor(finalDamage)} damage to the ${gameState.activeEnemy.name}.`);

        if (gameState.activeEnemy.health <= 0) {
            handleEnemyDefeat();
        } else {
            enemyTurnLogic();
        }
        updateUserInterface();
    }

    function handleEnemyDefeat() {
        if (gameState.activeEnemy.name === "NARRATOR") {
            showGameEnding("The author's pen is broken. You are no longer a character, you are free.");
        } else {
            addLogMessage("Enemy banished!");
            gameState.gold += 80;
            gameState.experience += 50;
            gameState.activeEnemy = null;

            if (gameState.experience >= gameState.experienceNeeded) {
                gameState.level += 1;
                gameState.skillPoints += 1;
                gameState.experience = 0;
                gameState.experienceNeeded *= 1.5;
                addLogMessage(`LEVEL UP! You are now level ${gameState.level}`, "var(--xp)");
            }
        }
    }

    function enemyTurnLogic() {
        if (!gameState.activeEnemy) return;

        if (gameState.activeEnemy.name === "NARRATOR") {
            const randomSpecialMove = Math.random();
            
            if (randomSpecialMove > 0.8) {
                addLogMessage("NARRATOR: 'This chapter needs a rewrite!' - He restores health!", "var(--gold)");
                gameState.activeEnemy.health = Math.min(gameState.activeEnemy.maxHealth, gameState.activeEnemy.health + 250);
            } else if (randomSpecialMove > 0.6) {
                addLogMessage("NARRATOR: 'You are just ink on paper!' - You are stunned!", "purple");
                gameState.isPlayerStunned = true;
                gameState.sanity += 10;
            } else if (randomSpecialMove > 0.4) {
                addLogMessage("NARRATOR: 'Let's erase your resources!' - Some ammo disappeared!", "red");
                gameState.ammo = Math.max(0, gameState.ammo - 15);
            } else {
                addLogMessage("The Narrator strikes your soul directly.", "var(--blood)");
                gameState.sanity += 20;
            }
        } else {
            let incomingDamage = 15 + (gameState.level * 2);
            if (gameState.skillsLearned.ironWill) incomingDamage *= 0.6;
            gameState.sanity += Math.floor(incomingDamage);
            addLogMessage("The ghost haunts your thoughts.", "var(--blood)");
        }

        if (gameState.sanity >= 100) {
            alert("Insanity has taken over. Game Over.");
            location.reload();
        }
        updateUserInterface();
    }

    function scoutArea() {
        gameState.sanity += 5;
        // –®–∞–Ω—Å –Ω–∞ –ù–∞—Ä—Ä–∞—Ç–æ—Ä–∞ —Ç–æ–ª—å–∫–æ —Å 10 —É—Ä–æ–≤–Ω—è
        const narratorChance = gameState.level >= 10 && Math.random() > 0.85;

        if (narratorChance) {
            gameState.activeEnemy = {
                name: "NARRATOR",
                health: 3000,
                maxHealth: 3000
            };
            addLogMessage("THE AUTHOR HAS ARRIVED TO FINISH YOUR STORY!", "var(--gold)");
        } else if (Math.random() > 0.5) {
            let ghostHealth = 150 + (gameState.level * 30);
            gameState.activeEnemy = {
                name: "GHOST",
                icon: "üëª",
                health: ghostHealth,
                maxHealth: ghostHealth
            };
            addLogMessage("A shadow takes form in front of you!");
        } else {
            const foundGold = 40 + (gameState.level * 5);
            gameState.gold += foundGold;
            addLogMessage(`You searched the ruins and found ${foundGold} gold.`);
        }
        updateUserInterface();
    }

    function openShop(itemType) {
        const itemPrices = { ammo: 25, tnt: 50, whiskey: 40, railgun: 3000 };
        
        if (gameState.gold < itemPrices[itemType]) {
            addLogMessage("You don't have enough gold!", "red");
            return;
        }

        if ((itemType === 'tnt' || itemType === 'whiskey') && gameState.inventory.length >= gameState.maxInventorySlots) {
            addLogMessage("Your saddlebags are full!", "red");
            return;
        }

        gameState.gold -= itemPrices[itemType];

        if (itemType === 'ammo') {
            gameState.ammo += 20;
            addLogMessage("Bought 20 bullets.");
        } else if (itemType === 'railgun') {
            gameState.hasRailgun = true;
            addLogMessage("You now possess the experimental Railgun!", "#00bcd4");
        } else {
            gameState.inventory.push(itemType);
            addLogMessage(`Purchased ${itemType}.`);
        }
        updateUserInterface();
    }

    function useInventoryItem(index) {
        const itemName = gameState.inventory[index];
        if (itemName === 'tnt' && gameState.activeEnemy) {
            gameState.activeEnemy.health -= 350;
            addLogMessage("DYNAMITE EXPLOSION! 350 damage!", "orange");
            if (gameState.activeEnemy.health <= 0) handleEnemyDefeat();
        } else if (itemName === 'whiskey') {
            gameState.sanity = Math.max(0, gameState.sanity - 40);
            addLogMessage("The whiskey calms your mind.");
        } else {
            addLogMessage("Can't use that right now.");
            return;
        }
        gameState.inventory.splice(index, 1);
        updateUserInterface();
    }

    function learnSkill(skillKey) {
        if (gameState.skillPoints >= 1 && !gameState.skillsLearned[skillKey]) {
            gameState.skillPoints -= 1;
            gameState.skillsLearned[skillKey] = true;
            addLogMessage(`Mastered: ${skillKey}`, "var(--xp)");
            updateUserInterface();
        }
    }

    function upgradeInventorySize() {
        if (gameState.skillPoints >= 2) {
            gameState.skillPoints -= 2;
            gameState.maxInventorySlots += 1;
            addLogMessage("Inventory expanded by 1 slot!", "var(--xp)");
            updateUserInterface();
        } else {
            addLogMessage("Expansion costs 2 Skill Points!", "red");
        }
    }

    function showGameEnding(finalText) {
        gameState.isGameFinished = true;
        document.getElementById('ending-screen').style.display = 'flex';
        document.getElementById('ending-message').innerText = finalText;
    }

    function startHuntingNight() { gameState.isNightTime = true; updateUserInterface(); }
    function returnToSafeTown() { gameState.isNightTime = false; gameState.sanity = 0; updateUserInterface(); }
    function closeAllMenus() { document.querySelectorAll('.overlay-window').forEach(menu => menu.style.display = 'none'); }

    window.onload = loadGame;
    updateUserInterface();
</script>
</body>
</html>
